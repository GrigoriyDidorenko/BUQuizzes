$(document).ready(function() {
    jQuery.ajax({
        type: "GET",
        url: '/guest/oneTimeTests',
        dataType: "json",
        contentType: "application/json; charset=utf-8",
        success: function (json) {
            var mail;
            $( "#email" )
                .change(function() {
                    var value = $( this ).val();
                    mail=value;
                })
                .change();
            var nick;
            $( "#nickname" )
            .change(function() {
                    var val = $( this ).val();
                    nick=val;
                })
                .change();
            var name;
            $( "#name" )
                .change(function() {
                    var valu = $( this ).val();
                    name=valu;
                })
                .change();
            var rols = json;
            var mas = [];
            $('select').material_select(
                $.each(rols, function (index, rolsone) {
                    var uniqu = true;
                    for (var i = 0; i < mas.length; i++) {
                        if (mas[i] == rolsone.categoryTestName) {
                            uniqu = false;
                        }
                    }
                    if (uniqu) {
                        mas.push(rolsone.categoryTestName)
                        $('select').append('<option value="' + rolsone.categoryTestName + '">' + rolsone.categoryTestName + '</option>')
                    }
                }))

                    $( "select" ).change(function() {
                        $("#testTable").empty();
                        var str = "";
                        $("#roles option:selected").each(function () {
                            str += $(this).text() + " ";
                        });
                        $.each(rols, function (index, rolsone) {
                            if ($.trim(str) == rolsone.categoryTestName) {

                                $("#testTable").append("<tr><td>" + rolsone.testName + "</td><td>" + rolsone.duration + " хв" + "</td><td><input class='submit save-btn-test test' type='submit' value='Розпочати' id='"+rolsone.id+"'></td></tr>");
                                //TODO
                                $(".test").click(function () {
                                    var id=this.id;
                                    // validate the comment form when it is submitted
                                    $("#commentForm").validate({
                                        submitHandler: function () {
                                            var testers = '/guest/tests/'+id+'?email='+mail+'&nickName='+nick+'';
                                            jQuery.ajax({
                                                type: "GET",
                                                url: testers,
                                                contentType: 'application/json; charset=utf-8',
                                                success: function (info) {
                                                    window.location.href = '/pages/openTests/TestPage.html?testId=' + id + '&email=' + mail + '&nickName=' + nick + '&name=' + name;
                                                },
                                                error: function(http) {
                                                    $('#error-back').empty();
                                                    $('#error-back').append(http.responseText);
                                                    // add active class to clicked element
                                                    $('#nickname').addClass('em')
                                                }

                                            });

                                        },
                                        rules: {
                                            name: "required",
                                            nick: "required",
                                            email: {
                                                required: true,
                                                email: true
                                            }
                                        },
                                        messages: {
                                            name: {
                                                required: "Please enter your name",
                                                minlength: "Your name must consist of at least 2 characters"
                                            },
                                            nick: {
                                                required: "Please enter your nick",
                                                minlength: "Your nick must be at least 5 characters long"
                                            },
                                            email: "Please enter a valid email address"
                                        }
                                    });
                                });
                            }
                        });

                    });
        }
    });
});
